def display_grv_interface(lang: str = 'ru'):
    """
    Отображение интерфейса для работы с ГРВ-изображениями в Streamlit.
    Обновленная версия для работы только с загрузкой файлов ГРВ-грамм без подключения к физической камере.
    
    Args:
        lang (str): Язык интерфейса ('ru' или 'en')
    """
    # Импортируем необходимые библиотеки
    import streamlit as st
    import matplotlib.pyplot as plt
    
    # Сбрасываем флаг загрузки сессии при новом рендеринге страницы
    # Но делаем это только если этот рендеринг не был вызван загрузкой сессии
    if 'session_loaded' in st.session_state and st.session_state.session_loaded:
        # Если сессия была загружена, оставляем флаг,
        # чтобы избежать бесконечной перезагрузки
        pass
    else:
        # Сбрасываем флаг session_loaded
        st.session_state.session_loaded = False
        
    st.title("Анализ ГРВ-грамм" if lang == 'ru' else "GRV-gram Analysis")
    
    # Показываем информацию о работе с загрузкой снимков
    st.info(
        "Загрузите имеющиеся ГРВ-граммы для каждого пальца обеих рук для получения энергетической модели." if lang == 'ru' else
        "Upload existing GRV-grams for each finger of both hands to get an energy model."
    )
    
    # Инициализация GRV-процессора, если он еще не инициализирован
    if 'grv_camera' not in st.session_state:
        st.session_state.grv_camera = GRVCamera(lang=lang)
    
    grv = st.session_state.grv_camera
    
    # Верхние кнопки управления
    col1, col2, col3 = st.columns(3)
    
    # Кнопка очистки
    if col3.button("Очистить все" if lang == 'ru' else "Clear all"):
        # Инициализируем заново все изображения пальцев
        grv.finger_images = {
            HandType.LEFT: {ft: None for ft in FingerType},
            HandType.RIGHT: {ft: None for ft in FingerType}
        }
        grv.processed_data = {
            HandType.LEFT: {ft: {} for ft in FingerType},
            HandType.RIGHT: {ft: {} for ft in FingerType}
        }
        st.success("Данные очищены" if lang == 'ru' else "Data cleared")
    
    # Выбор руки и пальца
    col1, col2 = st.columns(2)
    
    hand_options = {
        HandType.LEFT: "Левая рука" if lang == 'ru' else "Left hand",
        HandType.RIGHT: "Правая рука" if lang == 'ru' else "Right hand"
    }
    
    finger_options = {
        FingerType.THUMB: "Большой" if lang == 'ru' else "Thumb",
        FingerType.INDEX: "Указательный" if lang == 'ru' else "Index",
        FingerType.MIDDLE: "Средний" if lang == 'ru' else "Middle",
        FingerType.RING: "Безымянный" if lang == 'ru' else "Ring",
        FingerType.PINKY: "Мизинец" if lang == 'ru' else "Pinky"
    }
    
    selected_hand_label = col1.selectbox("Выберите руку:" if lang == 'ru' else "Select hand:", list(hand_options.values()))
    selected_hand = list(hand_options.keys())[list(hand_options.values()).index(selected_hand_label)]
    
    selected_finger_label = col2.selectbox("Выберите палец:" if lang == 'ru' else "Select finger:", list(finger_options.values()))
    selected_finger = list(finger_options.keys())[list(finger_options.values()).index(selected_finger_label)]
    
    # Загрузка ГРВ-изображения
    st.subheader("Загрузка ГРВ-граммы" if lang == 'ru' else "Upload GRV-gram")
    
    # Информация и подсказка по формату загружаемых файлов
    st.markdown(
        "Файлы ГРВ-грамм должны быть в формате BMP, JPEG или PNG. "
        "Рекомендуется использовать снимки, полученные с помощью программы РОК ГРВ-сканер." if lang == 'ru' else
        "GRV-gram files should be in BMP, JPEG or PNG format. "
        "It is recommended to use images obtained using the ROK GRV-scanner program."
    )
    
    uploaded_file = st.file_uploader(
        "Выберите файл ГРВ-граммы" if lang == 'ru' else "Choose a GRV-gram file", 
        type=["bmp", "jpg", "jpeg", "png"],
        key=f"grv_upload_{selected_hand.name}_{selected_finger.name}"
    )
    
    if uploaded_file is not None:
        # Обработка загруженного изображения
        process_uploaded_grv_image(grv, uploaded_file, selected_hand, selected_finger, lang, finger_options)
    
    # Панель состояния - показываем, какие пальцы уже отсканированы
    st.subheader("Статус загрузки ГРВ-грамм" if lang == 'ru' else "GRV-gram Upload Status")
    
    # Создаем сетку для отображения статуса
    hand_cols = st.columns(2)
    
    for i, hand in enumerate([HandType.LEFT, HandType.RIGHT]):
        with hand_cols[i]:
            st.write(hand_options[hand])
            finger_cols = st.columns(5)
            
            for j, finger in enumerate(FingerType):
                with finger_cols[j]:
                    if grv.finger_images[hand][finger] is not None:
                        st.success(finger_options[finger])
                    else:
                        st.error(finger_options[finger])
    
    # Кнопки для анализа и сохранения/загрузки
    st.subheader("Анализ и управление данными" if lang == 'ru' else "Analysis and Data Management")
    col1, col2, col3 = st.columns(3)
    
    # Кнопка для отображения полной визуализации, доступна если данные уже есть в session_state
    if "chakra_values_from_grv" in st.session_state and col3.button("Показать полную визуализацию" if lang == 'ru' else "Show full visualization", key="button_show_full_viz_main"):
        # Импортируем модули для визуализации
        from chakra_visualization import create_chakra_visualization
        from chakra_visualization_3d import create_chakra_visualization_3d
        from aura_photo import capture_aura_photo
        from organs_visualization import OrgansVisualizer
        from organ_detail_visualization import OrganDetailVisualizer
        
        # Берем данные из session_state
        energy_values = st.session_state.chakra_values_from_grv
        
        # Создаем 2D визуализацию чакр
        st.subheader("2D Визуализация чакр" if lang == 'ru' else "2D Chakra Visualization")
        fig_2d = create_chakra_visualization(energy_values, lang)
        st.pyplot(fig_2d)
        
        # Создаем 3D визуализацию чакр
        st.subheader("3D Визуализация чакр" if lang == 'ru' else "3D Chakra Visualization")
        fig_3d = create_chakra_visualization_3d(energy_values, lang)
        st.plotly_chart(fig_3d, use_container_width=True)
        
        # Добавляем опцию для создания фото с аурой
        st.subheader("Фото с аурой" if lang == 'ru' else "Aura Photo")
        st.markdown(
            "Вы можете сделать фото с камеры и наложить на него ауру, соответствующую вашему энергетическому состоянию."
            if lang == 'ru' else
            "You can take a photo from the camera and overlay an aura corresponding to your energy state."
        )
        
        if st.button("Сделать фото с аурой" if lang == 'ru' else "Take aura photo", key="button_aura_photo_analysis"):
            # Создаем фото с аурой
            capture_aura_photo(energy_values, lang)
            
        # Добавляем визуализацию здоровья органов
        st.subheader("Визуализация здоровья органов" if lang == 'ru' else "Organs Health Visualization")
        st.markdown(
            "Визуализация состояния внутренних органов на основе данных ГРВ-сканирования."
            if lang == 'ru' else
            "Visualization of internal organs health based on GRV scanning data."
        )
        
        # Создаем данные для визуализации органов
        # Преобразуем данные из энергий чакр в данные для диагностики
        diagnostic_data = {}
        
        # Отображение энергии чакр в параметры органов
        organ_param_mapping = {
            "Вязкость крови": energy_values.get("Root", 50) * 0.8 / 100,
            "Общий Холестерин": energy_values.get("Sacral", 50) * 0.7 / 100,
            "Липиды": energy_values.get("Solar Plexus", 50) * 0.75 / 100,
            "Сосудистое сопротивление": energy_values.get("Heart", 50) * 0.9 / 100,
            "Эластичность кровеносных сосудов": energy_values.get("Throat", 50) * 0.8 / 100,
            "Потребность миокарда в крови": energy_values.get("Heart", 50) * 0.85 / 100,
            "Объем перфузии крови в миокарде": energy_values.get("Heart", 50) * 0.9 / 100,
            "Объем потребления кислорода миокардом": energy_values.get("Throat", 50) * 0.8 / 100,
            "Ударный объем": energy_values.get("Heart", 50) * 0.9 / 100,
            "Сопротивление выбросу крови из левого желудочка": energy_values.get("Heart", 50) * 0.85 / 100,
            "Эластичность коронарных артерий": energy_values.get("Heart", 50) * 0.8 / 100,
            "Сила выброса левого желудочка": energy_values.get("Heart", 50) * 0.85 / 100,
            "Перфузионное давление коронарных артерий": energy_values.get("Heart", 50) * 0.8 / 100,
            "Эластичность церебральных сосудов": energy_values.get("Third Eye", 50) * 0.85 / 100,
            "Состояние кровоснабжения мозга": energy_values.get("Crown", 50) * 0.9 / 100
        }
        
        # Формируем словарь диагностических данных
        for param_name, param_value in organ_param_mapping.items():
            diagnostic_data[param_name] = {
                "value": param_value,
                "normal_min": 0.6,
                "normal_max": 0.9,
                "critical_min": 0.3,
                "critical_max": 1.0
            }
        
        # Создаем визуализатор органов и отображаем
        organs_visualizer = OrgansVisualizer(lang)
        fig_organs = organs_visualizer.create_organs_visualization(diagnostic_data)
        st.pyplot(fig_organs)
        
        # Добавляем выбор органа для подробной информации
        st.subheader("Детальная информация об органе" if lang == 'ru' else "Detailed Organ Information")
        
        # Список доступных органов
        organs = [
            "Головной мозг", "Сердце", "Легкие", "Печень", "Желудок", 
            "Поджелудочная железа", "Кишечник", "Почки", "Мочевой пузырь", 
            "Щитовидная железа", "Селезенка", "Надпочечники"
        ]
        
        # Выбор органа
        selected_organ = st.selectbox(
            "Выберите орган для детальной информации:" if lang == 'ru' else 
            "Select organ for detailed information:",
            organs
        )
        
        # Получаем информацию о статусе органа
        organ_status_info = organs_visualizer.get_organ_status_description(selected_organ, diagnostic_data)
        
        # Отображаем информацию
        if organ_status_info:
            st.markdown(f"**Статус:** {organ_status_info['status_label']}")
            st.markdown(f"**Параметры:**")
            
            for param_info in organ_status_info['parameters']:
                param_name = param_info['name']
                param_value = param_info['result']
                min_norm, max_norm = param_info['normal_range']
                
                # Нормализуем значение для прогресс-бара
                normalized_value = min(1.0, max(0.0, param_value / 100.0))
                st.progress(normalized_value)
                
                # Проверяем статус параметра
                if param_info['status'] == 'critical_low':
                    st.warning(f"{param_name}: {param_value:.2f} - Ниже нормы")
                elif param_info['status'] == 'critical_high':
                    st.warning(f"{param_name}: {param_value:.2f} - Выше нормы")
                elif param_info['status'] == 'normal':
                    st.success(f"{param_name}: {param_value:.2f} - В норме")
                else:
                    st.info(f"{param_name}: {param_value:.2f} - Пограничное значение")
            
            # Детальная визуализация органа
            detail_visualizer = OrganDetailVisualizer(lang)
            if detail_visualizer.has_detailed_image(selected_organ):
                st.subheader(f"Визуализация органа: {selected_organ}")
                fig_detail = detail_visualizer.create_organ_detail_view(
                    selected_organ, 
                    organ_status_info['status']
                )
                st.pyplot(fig_detail)
                
    # Кнопка анализа
    if col1.button("Анализировать" if lang == 'ru' else "Analyze"):
        # Проверяем, все ли пальцы отсканированы
        all_scanned = True
        for hand in HandType:
            for finger in FingerType:
                if grv.finger_images[hand][finger] is None:
                    all_scanned = False
                    break
        
        if not all_scanned:
            st.warning("Не все пальцы загружены. Для полного анализа загрузите ГРВ-граммы всех пальцев." if lang == 'ru' else 
                      "Not all fingers have been uploaded. For a complete analysis, upload GRV-grams of all fingers.")
        else:
            with st.spinner("Обработка изображений..." if lang == 'ru' else "Processing images..."):
                # Обрабатываем все изображения
                energy_model = grv.process_all_fingers()
                
                if "error" in energy_model:
                    st.error("Ошибка при обработке данных" if lang == 'ru' else "Error processing data")
                else:
                    # Показываем результаты анализа
                    st.success("Подготовка результатов анализа..." if lang == 'ru' else "Preparing analysis results...")
                    
                    # Отображаем значения энергии чакр
                    st.subheader("Энергетическая модель" if lang == 'ru' else "Energy Model")
                    
                    # Передаем данные в основное приложение через состояние сессии
                    st.session_state.chakra_values_from_grv = energy_model["chakra_values"]
                    
                    # Отображаем гистограмму значений чакр
                    fig, ax = plt.subplots(figsize=(10, 5))
                    chakras = list(energy_model["chakra_values"].keys())
                    values = list(energy_model["chakra_values"].values())
                    
                    ax.bar(chakras, values, color=['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'])
                    ax.set_ylim(0, 100)
                    ax.set_ylabel("Энергия (%)" if lang == 'ru' else "Energy (%)")
                    ax.set_title("Энергетический баланс чакр" if lang == 'ru' else "Chakra Energy Balance")
                    
                    st.pyplot(fig)
                    
                    # Отображаем индекс баланса
                    st.metric(
                        "Индекс баланса" if lang == 'ru' else "Balance Index", 
                        f"{energy_model['balance_index']:.2f}%"
                    )
                    
                    # Уведомление о готовности данных
                    st.success("Данные обработаны и готовы к использованию в основном приложении." if lang == 'ru' else 
                             "Data processed and ready for use in the main application.")
                    
                    # Добавляем кнопку для создания и отображения полной визуализации
                    if st.button("Показать полную визуализацию" if lang == 'ru' else "Show Full Visualization", key="button_show_full_viz_analysis"):
                        # Показываем визуализацию ауры
                        st.subheader("Визуализация ауры" if lang == 'ru' else "Aura Visualization")
                        
                        # Используем функцию из aura_photo для создания изображения ауры
                        from aura_photo import create_aura_only, overlay_aura_on_photo
                        
                        # Создаем только изображение ауры
                        aura_img = create_aura_only(energy_model["chakra_values"], width=600, height=800)
                        
                        # Выводим изображение ауры
                        st.image(aura_img, caption="Аура" if lang == 'ru' else "Aura", use_column_width=True)
                        
                        # Визуализация чакр
                        st.subheader("Визуализация чакр" if lang == 'ru' else "Chakra Visualization")
                        
                        # Используем функцию из chakra_visualization
                        from chakra_visualization import create_chakra_visualization
                        
                        # Создаем визуализацию чакр
                        fig_chakra = create_chakra_visualization(energy_model["chakra_values"], lang)
                        st.pyplot(fig_chakra)
                        
                        # Визуализация органов
                        st.subheader("Состояние органов" if lang == 'ru' else "Organs State")
                        
                        # Используем функцию из organs_visualization
                        from organs_visualization import OrgansVisualizer
                        
                        # Тут мы конвертируем значения чакр в диагностические данные для органов
                        # Это упрощенная версия для демонстрации
                        diagnostic_data = {}
                        
                        # Создаем простое отображение на основании энергии чакр
                        for param, mapping in DiagnosticReportAnalyzer.parameter_to_chakra_mapping.items():
                            # Рассчитываем значение параметра на основе энергии чакр
                            param_value = 0
                            weight_sum = 0
                            
                            for chakra_name, weight in mapping:
                                if chakra_name in energy_model["chakra_values"]:
                                    param_value += energy_model["chakra_values"][chakra_name] * weight
                                    weight_sum += weight
                            
                            if weight_sum > 0:
                                param_value = param_value / weight_sum
                                
                                # Определяем статус на основе значения
                                status = "normal"
                                if param_value < 40:
                                    status = "low"
                                elif param_value > 80:
                                    status = "high"
                                
                                # Записываем данные
                                diagnostic_data[param] = {
                                    "result": param_value,
                                    "normal_range": (40, 80),
                                    "status": status
                                }
                        
                        # Создаем визуализатор органов
                        organs_viz = OrgansVisualizer(lang)
                        
                        # Создаем визуализацию органов
                        fig_organs = organs_viz.create_organs_visualization(diagnostic_data)
                        st.pyplot(fig_organs)
                        
                        # Добавляем детальную информацию о чакрах
                        st.subheader("Детальная информация о чакрах" if lang == 'ru' else "Detailed Chakra Information")
                        
                        # Получаем детальную информацию о каждой чакре
                        chakra_details = grv.get_energy_details(energy_model["chakra_values"])
                        
                        # Отображаем информацию в аккордеоне для каждой чакры
                        for chakra_name, details in chakra_details.items():
                            with st.expander(f"{chakra_name} - {details['status']}"):
                                st.write(f"**Энергия:** {details['energy']:.1f}%")
                                st.write(f"**Состояние:** {details['status']}")
                                st.write(f"**Описание:** {details['description']}")
                        
                        # Добавляем возможность сохранить результаты в PDF
                        st.download_button(
                            "Сохранить отчет (PDF)" if lang == 'ru' else "Save Report (PDF)",
                            data="PDF Report Coming Soon",  # Здесь будет PDF
                            file_name="energy_report.pdf",
                            mime="application/pdf"
                        )
    
    # Блок для сохранения и загрузки сессии
    st.subheader("Сохранение и загрузка сессии" if lang == 'ru' else "Save and Load Session")
    
    # Информационное сообщение
    st.info(
        "Сессия сохраняется в файл, который вы можете скачать и загрузить позже, чтобы не повторять загрузку ГРВ-грамм." if lang == 'ru' else
        "The session is saved to a file that you can download and upload later to avoid repeating the upload of GRV-grams."
    )
    
    save_col1, save_col2 = st.columns(2)
    
    # Поле для ввода имени файла для сохранения
    with save_col1:
        save_filename = st.text_input(
            "Имя файла для сохранения" if lang == 'ru' else "Filename for saving", 
            value="grv_session.json"
        )
        
        # Кнопка сохранения
        if st.button("Сохранить сессию" if lang == 'ru' else "Save session"):
            if grv.save_session(save_filename):
                # Подготавливаем ссылку на скачивание файла
                import base64
                import os
                if os.path.exists(save_filename):
                    with open(save_filename, "rb") as file:
                        file_content = file.read()
                        b64_content = base64.b64encode(file_content).decode()
                        
                        download_href = f'<a href="data:application/octet-stream;base64,{b64_content}" download="{save_filename}">Скачать файл сессии</a>'
                        st.markdown(download_href, unsafe_allow_html=True)
                        
                        st.success(
                            f"Сессия успешно сохранена в файл {save_filename}. Нажмите на ссылку выше для скачивания." if lang == 'ru' else 
                            f"Session successfully saved to file {save_filename}. Click the link above to download."
                        )
                else:
                    st.error(
                        f"Файл {save_filename} не найден после сохранения" if lang == 'ru' else 
                        f"File {save_filename} not found after saving"
                    )
    
    # Блок для загрузки сессии
    with save_col2:
        # Файловый загрузчик для выбора файла сессии
        uploaded_session = st.file_uploader(
            "Выберите файл сессии для загрузки" if lang == 'ru' else "Choose a session file to load",
            type=["json", "dat"],
            key="session_uploader"
        )
        
        if uploaded_session is not None:
            # Сохраняем загруженный файл во временный файл
            import os
            import tempfile
            
            # Создаем временный файл для сохранения загруженного файла
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=".json")
            temp_file.write(uploaded_session.getvalue())
            temp_file.close()
            
            # Важно: передаем полный путь к временному файлу
            session_file_path = temp_file.name
            print(f"Попытка загрузки сессии из: {session_file_path}")
            
            # Загружаем сессию из временного файла, проверяя что файл существует
            if os.path.exists(session_file_path) and grv.load_session(session_file_path):
                st.success(
                    f"Сессия успешно загружена из файла {uploaded_session.name}" if lang == 'ru' else 
                    f"Session successfully loaded from file {uploaded_session.name}"
                )
                
                # Обновляем статус загрузки в интерфейсе
                st.subheader("Загруженные данные" if lang == 'ru' else "Loaded Data")
                
                # Показываем загруженные изображения
                loaded_images_count = 0
                for hand in HandType:
                    for finger in FingerType:
                        if grv.finger_images[hand][finger] is not None:
                            loaded_images_count += 1
                
                st.info(
                    f"Загружено {loaded_images_count} из 10 ГРВ-грамм" if lang == 'ru' else
                    f"Loaded {loaded_images_count} out of 10 GRV-grams"
                )
                
                # Если есть загруженные данные по чакрам, показываем их
                if "chakra_values_from_grv" in st.session_state:
                    energy_values = st.session_state.chakra_values_from_grv
                    
                    # Отображаем энергетический баланс
                    st.subheader("Энергетическая модель" if lang == 'ru' else "Energy Model")
                    
                    # Отображаем гистограмму значений чакр
                    import matplotlib.pyplot as plt
                    fig, ax = plt.subplots(figsize=(10, 5))
                    chakras = list(energy_values.keys())
                    values = list(energy_values.values())
                    
                    ax.bar(chakras, values, color=['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'])
                    ax.set_ylim(0, 100)
                    ax.set_ylabel("Энергия (%)" if lang == 'ru' else "Energy (%)")
                    ax.set_title("Энергетический баланс чакр" if lang == 'ru' else "Chakra Energy Balance")
                    
                    st.pyplot(fig)
                    
                    # Рассчитываем индекс баланса
                    balance_index = grv.calculate_balance_index(energy_values)
                    
                    # Отображаем индекс баланса
                    st.metric(
                        "Индекс баланса" if lang == 'ru' else "Balance Index", 
                        f"{balance_index:.2f}%"
                    )
                    
                    # Добавляем кнопку для отображения полной визуализации
                    if st.button("Показать полную визуализацию" if lang == 'ru' else "Show full visualization", key="button_show_full_viz_load"):
                        # Импортируем модули для визуализации
                        from chakra_visualization import create_chakra_visualization
                        from chakra_visualization_3d import create_chakra_visualization_3d
                        from aura_photo import capture_aura_photo
                        
                        # Создаем 2D визуализацию чакр
                        st.subheader("2D Визуализация чакр" if lang == 'ru' else "2D Chakra Visualization")
                        fig_2d = create_chakra_visualization(energy_values, lang)
                        st.pyplot(fig_2d)
                        
                        # Создаем 3D визуализацию чакр
                        st.subheader("3D Визуализация чакр" if lang == 'ru' else "3D Chakra Visualization")
                        fig_3d = create_chakra_visualization_3d(energy_values, lang)
                        st.plotly_chart(fig_3d, use_container_width=True)
                        
                        # Добавляем опцию для создания фото с аурой
                        st.subheader("Фото с аурой" if lang == 'ru' else "Aura Photo")
                        st.markdown(
                            "Вы можете сделать фото с камеры и наложить на него ауру, соответствующую вашему энергетическому состоянию."
                            if lang == 'ru' else
                            "You can take a photo from the camera and overlay an aura corresponding to your energy state."
                        )
                        
                        if st.button("Сделать фото с аурой" if lang == 'ru' else "Take aura photo", key="button_aura_photo_main"):
                            # Создаем фото с аурой
                            capture_aura_photo(energy_values, lang)
                            
                        # Добавляем визуализацию здоровья органов
                        st.subheader("Визуализация здоровья органов" if lang == 'ru' else "Organs Health Visualization")
                        st.markdown(
                            "Визуализация состояния внутренних органов на основе данных ГРВ-сканирования."
                            if lang == 'ru' else
                            "Visualization of internal organs health based on GRV scanning data."
                        )
                        
                        # Импортируем модуль для визуализации органов
                        from organs_visualization import OrgansVisualizer
                        
                        # Создаем данные для визуализации органов
                        # Преобразуем данные из энергий чакр в данные для диагностики
                        diagnostic_data = {}
                        
                        # Отображение энергии чакр в параметры органов
                        organ_param_mapping = {
                            "Вязкость крови": energy_values.get("Root", 50) * 0.8 / 100,
                            "Общий Холестерин": energy_values.get("Sacral", 50) * 0.7 / 100,
                            "Липиды": energy_values.get("Solar Plexus", 50) * 0.75 / 100,
                            "Сосудистое сопротивление": energy_values.get("Heart", 50) * 0.9 / 100,
                            "Эластичность кровеносных сосудов": energy_values.get("Throat", 50) * 0.8 / 100,
                            "Потребность миокарда в крови": energy_values.get("Heart", 50) * 0.85 / 100,
                            "Объем перфузии крови в миокарде": energy_values.get("Heart", 50) * 0.9 / 100,
                            "Объем потребления кислорода миокардом": energy_values.get("Throat", 50) * 0.8 / 100,
                            "Ударный объем": energy_values.get("Heart", 50) * 0.9 / 100,
                            "Сопротивление выбросу крови из левого желудочка": energy_values.get("Heart", 50) * 0.85 / 100,
                            "Эластичность коронарных артерий": energy_values.get("Heart", 50) * 0.8 / 100,
                            "Сила выброса левого желудочка": energy_values.get("Heart", 50) * 0.85 / 100,
                            "Перфузионное давление коронарных артерий": energy_values.get("Heart", 50) * 0.8 / 100,
                            "Эластичность церебральных сосудов": energy_values.get("Third Eye", 50) * 0.85 / 100,
                            "Состояние кровоснабжения мозга": energy_values.get("Crown", 50) * 0.9 / 100
                        }
                        
                        # Формируем словарь диагностических данных
                        for param_name, param_value in organ_param_mapping.items():
                            diagnostic_data[param_name] = {
                                "value": param_value,
                                "normal_min": 0.6,
                                "normal_max": 0.9,
                                "critical_min": 0.3,
                                "critical_max": 1.0
                            }
                        
                        # Создаем визуализатор органов и отображаем
                        organs_visualizer = OrgansVisualizer(lang)
                        fig_organs = organs_visualizer.create_organs_visualization(diagnostic_data)
                        st.pyplot(fig_organs)
                        
                        # Добавляем выбор органа для подробной информации
                        st.subheader("Детальная информация об органе" if lang == 'ru' else "Detailed Organ Information")
                        
                        # Импортируем модуль для детальной визуализации органов
                        from organ_detail_visualization import OrganDetailVisualizer
                        
                        # Список доступных органов
                        organs = [
                            "Головной мозг", "Сердце", "Легкие", "Печень", "Желудок", 
                            "Поджелудочная железа", "Кишечник", "Почки", "Мочевой пузырь", 
                            "Щитовидная железа", "Селезенка", "Надпочечники"
                        ]
                        
                        # Выбор органа
                        selected_organ = st.selectbox(
                            "Выберите орган для детальной информации:" if lang == 'ru' else 
                            "Select organ for detailed information:",
                            organs
                        )
                        
                        # Получаем информацию о статусе органа
                        organ_status_info = organs_visualizer.get_organ_status_description(selected_organ, diagnostic_data)
                        
                        # Отображаем информацию
                        if organ_status_info:
                            st.markdown(f"**Статус:** {organ_status_info['status_label']}")
                            st.markdown(f"**Параметры:**")
                            
                            for param_info in organ_status_info['parameters']:
                                param_name = param_info['name']
                                param_value = param_info['result']
                                normal_min, normal_max = param_info['normal_range']
                                
                                # Отображаем прогресс
                                normalized_value = min(100, max(0, param_value)) # ограничиваем от 0 до 100 для progress bar
                                st.progress(normalized_value / 100)  # progress принимает значения от 0 до 1
                                
                                # Проверяем статус параметра
                                if param_info['status'] == 'critical_low':
                                    st.warning(f"{param_name}: {param_value:.2f} - Ниже нормы")
                                elif param_info['status'] == 'critical_high':
                                    st.warning(f"{param_name}: {param_value:.2f} - Выше нормы") 
                                elif param_info['status'] == 'normal':
                                    st.success(f"{param_name}: {param_value:.2f} - В норме")
                                else:
                                    st.info(f"{param_name}: {param_value:.2f} - Пограничное значение")
                            
                            # Детальная визуализация органа
                            detail_visualizer = OrganDetailVisualizer(lang)
                            if detail_visualizer.has_detailed_image(selected_organ):
                                st.subheader(f"Визуализация органа: {selected_organ}")
                                fig_detail = detail_visualizer.create_organ_detail_view(
                                    selected_organ, 
                                    organ_status_info['status']
                                )
                                st.pyplot(fig_detail)
                    
                # Устанавливаем флаг, что сессия загружена
                import streamlit as st
                st.session_state.session_loaded = True
                # НЕ делаем перезагрузку здесь, так как она уже отображается в интерфейсе
            else:
                st.error(
                    "Ошибка при загрузке сессии" if lang == 'ru' else 
                    "Error loading session"
                )
            
            # Удаляем временный файл
            os.unlink(temp_file.name)


# Пример использования, если скрипт запущен напрямую
if __name__ == "__main__":
    display_grv_interface(lang='ru')